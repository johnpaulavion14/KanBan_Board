<div style="height: 90vh;width: 100vw; overflow:scroll; ">
  <table class="table table-hover text-center">
    <thead>
      <tr style="color: #0067a3; border-bottom: 3px solid #0067a3; height: 50px; vertical-align: middle;">
        <th scope="col" style="min-width:50px;"></th>
        <th scope="col">Task Name</th>
        <th scope="col">Duration</th>
        <th scope="col">Start</th>
        <th scope="col"></th>
        <th scope="col">Finish</th>
        <th scope="col">Assigned To</th>
        <th scope="col">% Complete</th>
        <th scope="col">Status</th>
        <th scope="col">Remarks</th>
      </tr>
    </thead>
    <tbody>
      <% @rocks.each do |rock| %>
        <!-- All Rocks -->
        <tr class="all-rocks" style="background-color:#cccdd4; font-weight: bold; vertical-align: middle;">
          <td class="notif-con"><%= image_tag ("message.png"), class:"message-icon project-icon" %></td>
          <td style="display: none;" id="rock-id"><%= rock.id %></td>
          <td class="task-name" style="text-align: left; min-width: 100px;">
            <%= image_tag ("plus.png"),role:"button", style:"margin-left:1rem",class:"plus-icon" %>
            <%= image_tag ("minus.png"),role:"button", style:"margin-left:1rem",class:"minus-icon" %>
            <%= rock.task_name %>
          </td>
          <!-- display none -->
          <td style="display: none;" id="percent-sum"><%= rock.milestones.pluck(:complete).reduce(:+) %></td>
          <td style="display: none;" id="m-count"><%= rock.milestones.count %></td>
          <!-- display none -->
          <td>
            <%= (rock.start.to_date..rock.finish.to_date).count do |date|
              date.workday?
            end %> days
          </td>
          <td>[ <%= rock.start.strftime("%b %d, %Y") %></td>
          <td>>></td>
          <td><%= rock.finish.strftime("%b %d, %Y") %> ]</td>
          <td class="assigned">
            <% if !rock.user.profilepics.blank? %>
              <%= image_tag rock.user.profilepics.last.pic, class:"assigned-pics", title:rock.user.email %>
            <% end %>
            <% @all_users.each do |user| %>
              <% if rock.assigned.include? user.email %>
                <% if user.id == rock.user.id %>
                <% elsif !user.profilepics.blank?%>
                  <%= image_tag user.profilepics.last.pic, class:"assigned-pics", title:user.email %>
                <% else %>
                  <%= image_tag ("profile-pic.png"), class:"assigned-pics", title:user.email %>
                <% end %>
              <% end %>
            <% end %>
          </td>
          <td class="rock-percent"><span></span> %</td>
          <td class="rock-status com-status d-flex align-items-center py-2">
            <div id="stat" class="px-3 py-2" style="flex:4"></div>
            <% if rock.finish >= Date.today %>
              <div style="margin-left: 1rem; flex:1;text-align:start;" role="button" title="on track"><%= image_tag ("green_circle.png")%></div>  
            <% else %>
              <div style="margin-left: 1rem; flex:1;text-align:start;" role="button" title="off track"><%= image_tag ("red_circle.png")%></div>  
            <% end %>
          </td>
          <td class="remarks" style="max-width:200px; overflow-x: auto;"><%= rock.remarks %></td>
        </tr>
        <!-- All Milestones -->
        <% @milestones.each do |milestone| %> 
          <% if rock.id == milestone.rock_id %>
            <tr class="all-milestones rock-<%= rock.id %>" style="vertical-align: middle;">
              <td class="notif-con" ><%= image_tag ("message.png"), class:"message-icon project-icon", style:"margin-left: 30px;" %></td>
              <td style="display: none;" id="rock-id"><%= rock.id %></td>
              <td style="display: none;" id="milestone-id"><%= milestone.id %></td>
              <td class="task-name" style="text-align: left; min-width: 100px; padding-left:4rem"><%= milestone.task_name %></td>
              <td>
                <%= (milestone.start.to_date..milestone.finish.to_date).count do |date|
                  date.workday?
                end %> days
              </td>
              <td>[ <%= milestone.start.strftime("%b %d, %Y") %></td>
              <td>>></td>
              <td><%= milestone.finish.strftime("%b %d, %Y") %> ]</td>
              <td class="assigned">
                <% if !milestone.user.profilepics.blank? %>
                  <%= image_tag milestone.user.profilepics.last.pic, class:"assigned-pics", title:milestone.user.email %>
                <% end %>
                <% @all_users.each do |user| %>
                  <% if user.id == milestone.user.id %>
                  <% elsif milestone.assigned.include? user.email %>
                    <% if !user.profilepics.blank? %>
                      <%= image_tag user.profilepics.last.pic, class:"assigned-pics", title:user.email %>
                    <% else %>
                      <%= image_tag ("profile-pic.png"), class:"assigned-pics", title:user.email %>
                    <% end %>
                  <% end %>
                <% end %>
              </td>
              <td><span class="complete"><%= milestone.complete %></span> %</td>
              <td class="status com-status d-flex align-items-center justify-content-center px-4">
                <% case milestone.complete %>
                  <% when 0 %>
                    <div class="bg-danger px-2 py-1" style="flex:4">Not Started</div>
                  <% when 100 %>
                    <div class="bg-warning p-2 py-1" style="flex:4">Complete</div>
                  <% else %>
                    <div class="bg-success p-2 py-1" style="flex:4">In Progress</div>
                <% end %>

                <% if milestone.finish >= Date.today %>
                  <div style="margin-left: 1rem; flex:1;text-align:start;" role="button" title="on track"><%= image_tag ("green_circle.png")%></div>  
                <% else %>
                  <div style="margin-left: 1rem; flex:1;text-align:start;" role="button" title="off track"><%= image_tag ("red_circle.png")%></div>  
                <% end %>
              </td>
              <td class="remarks" style="max-width:200px; overflow-x: auto;"><%= milestone.remarks %></td>
            </tr>
          <% end %>
        <% end %>
        <tr>
          <td></td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
        </tr>
      <% end %>
    </tbody>
  </table>

</div>

<script>

  $(document).ready(function(){

     // hover messages
    // $(".message-icon").css("display","none")
    // $(".notif-con").hover(function(){
    //   $(this).children(".message-icon").toggle()
    // })

   // Complete and Status Column
   $(".rock-percent").each( function(index,value) {
      // Rock Percentage Value
      let percent_sum = $(value).siblings("#percent-sum").text()
      let m_count = $(value).siblings("#m-count").text()
      let total_rock_percent = m_count == "0" ? 0 : (parseInt(percent_sum) / (100 *  parseInt(m_count))) * 100
      $(value).children("span").text(total_rock_percent.toFixed(2))
      // Status Value and Complete status style
      let rock_percent = $(value).children("span").text()
      if (rock_percent == "0.00") {
        $(value).siblings(".rock-status").children("#stat").text("Not Started")
        $(value).siblings(".rock-status").children("#stat").css("background-color", "red")
      }else if (rock_percent == "100.00") {
        $(value).siblings(".rock-status").children("#stat").text("Complete")
        $(value).siblings(".rock-status").children("#stat").css("background-color", "yellow")
      }else {
        $(value).siblings(".rock-status").children("#stat").text("In Progress")
        $(value).siblings(".rock-status").children("#stat").css("background-color", "green")
      }
    });
    
    $(".com-status").each( function(index,value) {
      if ($(value).text().replace(/\s/g, "") == "Complete"){
        $(value).parents("tr").children("td").not(".notif-con").css("text-decoration", "line-through")
        $(value).parents("tr").children("td").not(".notif-con").css("text-decoration-color", "red")
        $(value).parents("tr").children("td").not(".notif-con").css("font-style", "italic")
      }
    });

    // -----Milestone Section------

    // Show / Hide Milestones
    $(".minus-icon").css("display", "none")
    $(".all-milestones").css("display", "none")
    $(".new-milestone").css("display", "none")
    $(".blank-milestone").css("display", "none")
    $(".plus-icon").each( function(index,plus) {
      $(plus).click(function(){
        $(this).hide()
        $(this).next(".minus-icon").show()
        var id = $(plus).parents(".task-name").siblings("#rock-id").text()
        var rock_id = ".rock-" + id
        $(rock_id).show()
        $(rock_id + ".new-milestone").hide()
      });
    });
    $(".minus-icon").each( function(index,minus) {
      $(minus).click(function(){
        $(this).hide()
        $(this).prev(".plus-icon").show()
        var id = $(minus).parents(".task-name").siblings("#rock-id").text()
        var rock_id = ".rock-" + id
        $(rock_id).hide()
      });
    });
   
  });
  
</script>
